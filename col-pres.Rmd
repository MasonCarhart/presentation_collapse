---
title: "Colapse"
author: "Mason Carhart"
date: "4/9/2021"
output:
  xaringan::moon_reader:
    css: [default, metropolis, metropolis-fonts] 
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(pacman)
p_load( dplyr, collapse, microbenchmark, xaringan, kniter, nycflights13, lubridate, data.table)
```

# Collapse Package

## Perks

- Increased efficiency, (claimed to be 10x the speed of data.table)

- Simple implementation 

- Uses C/C++

- Minimal dependency 




---

# Speed Comparison and Motivation 
```{r Speed Test 1, echo=TRUE}
storms_dt = as.data.table(storms)

microbenchmark(collapse = storms_dt %>% gby(category) %>% get_vars(10:11) %>% fmean,
               data.table = storms_dt[, lapply(.SD, mean), keyby = category
                                             , .SDcols = 10:11], times = 100)
```

### Confirmation that they produce the same output
```{r Speed Test Confirm, echo=TRUE}
storms_dt %>% gby(category) %>% get_vars(10:11) %>% fmean %>% head(1)

storms_dt[, lapply(.SD, mean), keyby = category, .SDcols = 10:11] %>% head(1)

```

---
# Unfair Test

```{r Speed Test 2, echo=TRUE}

storms_dt = as.data.table(storms)

microbenchmark(collapse = storms_dt %>% gby(category) %>% get_vars(10:11) %>% fmean,
                      data.table = storms_dt[, lapply(.SD, mean),
                                             .SDcols = 10:11], times = 100)

```

---

# Collapse


- dplyr integration 

```{r, echo=TRUE}

                                  # Fast Mean of wind and pressure
storms_dt %>% group_by(year) %>% select_at(6:7) %>% fmean %>% tail(4) 
                                      

```

---
# data.table integration

All the code has been done from a data.table object.

```{r, echo=TRUE}

storms_dt %>% fsubset(year, wind, pressure) %>% # Fast "Subset"
  ftransform(wind_over_presure_per = wind / pressure * 100,  # Computing % of wind to pressure
             wind_mean = fmean(wind)) %>%    # Mean wind
             tail(2)


```


---
# Time series and other class integration

```{r, echo=TRUE}

storms_fselected <- storms_dt %>% fselect(year, wind, pressure) %>% na_omit

 storms_fselected %>% head(2)

storms_lubridate <- storms_dt %>% 
                  ftransform(date = make_date(year, month, day)) %>%  
                  fselect(date, wind, pressure) %>% na_omit 

storms_lubridate %>% head(2)



```


---
# Bigger Data Set

```{r Speed Test 3, echo=TRUE}
sflights_dt = as.data.table(flights) 

microbenchmark(collapse = sflights_dt %>% fgroup_by(year) %>% 
                    get_vars(16) %>% fmean,
               data.table = sflights_dt[, lapply(.SD, mean), keyby = year
                    , .SDcols = 16], times = 100)
```
---
# With :=


```{r Speed Test 4 With , echo=TRUE}
microbenchmark(collapse = sflights_dt %>% fgroup_by(year) %>% 
                    get_vars(16) %>% fmean,
               data.table = sflights_dt[, mean := mean(distance, na.rm=T)], times = 100)

sflights_dt %>% fgroup_by(year) %>% get_vars(16) %>% fmean %>% head()
sflights_dt[, mean_flight := mean(distance, na.rm=T),keyby = year] %>% 
  .[1, .(year, mean_flight)]

```
Key note is that the data.table has made a collum in the sflights_dt, while collapse has mad a value.

---

# Helpfull Rescorces and Links

- Collapse Git Hub Page https://github.com/SebKrantz/collapse

- Function Overview https://sebkrantz.github.io/collapse/reference/index.html

- Collapse Cheat Sheet https://raw.githubusercontent.com/SebKrantz/cheatsheets/master/pngs/collapse.png

- dplyr Integration https://sebkrantz.github.io/collapse/articles/collapse_and_dplyr.html

- data.table Integration https://sebkrantz.github.io/collapse/articles/collapse_and_data.table.html

- plm Integration https://sebkrantz.github.io/collapse/articles/collapse_and_plm.html






